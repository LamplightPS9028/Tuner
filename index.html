<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="author" content="Abdel Halim Bouguedra">
    <meta name="viewport" content="width=device-width minimum-scale=1 maximum-scale=1">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Piano Tuner</title>
</head>

<body>
    <div id="display" class="display"><span style="font-size: 150%;">â™ª</span></div>
    <div id="frequency" class="frequency"></div>
    <div id="note-info" class="note-info"></div>
    <div id="tuning-feedback" class="tuning-feedback"></div>

    <canvas id="canvas" class="cnv"></canvas>
    <canvas id="visualization" class="visualization"></canvas>

    <script src="lib/wad.js"></script>
    <script>
        // Constants for tuning frequency ranges
        const A4_FREQUENCY = 440; // A4 frequency in Hz
        const SEMITONE_RATIO = Math.pow(2, 1 / 12); // Frequency ratio between adjacent semitones

        const NOTE_NAMES = [
            "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"
        ];

        // Function to calculate the note name based on frequency
        function getNoteFromFrequency(frequency) {
            const noteIndex = Math.round(12 * Math.log2(frequency / A4_FREQUENCY)) % 12;
            return NOTE_NAMES[(noteIndex + 12) % 12];
        }

        // Function to calculate the deviation from the ideal frequency
        function calculateDeviation(frequency, idealFrequency) {
            return Math.abs(frequency - idealFrequency);
        }

        // Function to check if the piano note is in tune
        function checkTuning(frequency, note) {
            const noteFrequency = A4_FREQUENCY * Math.pow(SEMITONE_RATIO, NOTE_NAMES.indexOf(note) - 9); // Calculate ideal frequency for note
            const deviation = calculateDeviation(frequency, noteFrequency);

            let feedbackMessage = `Note: ${note}\nFrequency: ${frequency.toFixed(2)} Hz`;
            if (deviation <= 1) {
                feedbackMessage += "\nThis note is in tune! ðŸŽµ";
            } else {
                feedbackMessage += `\nThis note is slightly off-tune. Please call a piano tuner if the difference is significant.`;
            }

            document.getElementById("tuning-feedback").innerText = feedbackMessage;
        }

        // Function to get microphone input and analyze pitch
        function startTuning() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const analyser = audioContext.createAnalyser();
                    const microphone = audioContext.createMediaStreamSource(stream);
                    microphone.connect(analyser);
                    analyser.fftSize = 2048;

                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    function detectPitch() {
                        analyser.getByteFrequencyData(dataArray);

                        let maxAmplitude = 0;
                        let dominantFrequency = 0;
                        for (let i = 0; i < bufferLength; i++) {
                            if (dataArray[i] > maxAmplitude) {
                                maxAmplitude = dataArray[i];
                                dominantFrequency = i * audioContext.sampleRate / analyser.fftSize;
                            }
                        }

                        const note = getNoteFromFrequency(dominantFrequency);
                        document.getElementById("note-info").innerText = `Detected Note: ${note}`;
                        document.getElementById("frequency").innerText = `Frequency: ${dominantFrequency.toFixed(2)} Hz`;

                        checkTuning(dominantFrequency, note);

                        requestAnimationFrame(detectPitch);
                    }

                    detectPitch();
                })
                .catch(function (err) {
                    console.error('Error accessing microphone: ', err);
                    alert("Error accessing the microphone. Please grant permission.");
                });
        }

        // Start the tuner
        startTuning();
    </script>
</body>

</html>
