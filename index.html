<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Piano Tuner App</title>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

	<!-- Simple tuner script -->
	<script src="https://halimb.github.io/simple-tuner/simple-tuner.js"></script>

	<script>
	// Wait for the page to load before initializing the tuner
	window.addEventListener('load', init_tuner, false);

	let audioContext, analyser, microphone;
	let noteDisplay, frequencyDisplay, tuningDisplay, feedbackDisplay, waveformCanvas;
	const pianoNoteFrequencies = {
		"A0": 27.5, "A#0": 29.135, "B0": 30.868, "C1": 32.703, "C#1": 34.648, "D1": 36.708,
		"D#1": 38.891, "E1": 41.203, "F1": 43.654, "F#1": 46.249, "G1": 48.999, "G#1": 51.913,
		"A1": 55.000, "A#1": 58.270, "B1": 61.735, "C2": 65.406, "C#2": 69.296, "D2": 73.416,
		"D#2": 77.782, "E2": 82.407, "F2": 87.307, "F#2": 92.499, "G2": 97.999, "G#2": 103.826,
		"A2": 110.000, "A#2": 116.541, "B2": 123.471, "C3": 130.813, "C#3": 138.591, "D3": 146.832,
		"D#3": 155.563, "E3": 164.814, "F3": 174.614, "F#3": 184.997, "G3": 195.998, "G#3": 207.652,
		"A3": 220.000, "A#3": 233.082, "B3": 246.942, "C4": 261.626, "C#4": 277.183, "D4": 293.665,
		"D#4": 311.127, "E4": 329.628, "F4": 349.228, "F#4": 369.994, "G4": 392.000, "G#4": 415.305,
		"A4": 440.000, "A#4": 466.164, "B4": 493.883, "C5": 523.251, "C#5": 554.365, "D5": 587.330,
		"D#5": 622.254, "E5": 659.255, "F5": 698.456, "F#5": 739.989, "G5": 783.991, "G#5": 830.609,
		"A5": 880.000, "A#5": 932.328, "B5": 987.767, "C6": 1046.502, "C#6": 1108.731, "D6": 1174.659,
		"D#6": 1244.508, "E6": 1318.510, "F6": 1396.913, "F#6": 1479.978, "G6": 1567.982, "G#6": 1661.219,
		"A6": 1760.000, "A#6": 1864.656, "B6": 1975.533, "C7": 2093.004, "C#7": 2217.461, "D7": 2349.318,
		"D#7": 2491.016, "E7": 2637.020, "F7": 2793.826, "F#7": 2959.955, "G7": 3135.964, "G#7": 3322.438,
		"A7": 3520.000, "A#7": 3729.312, "B7": 3951.066, "C8": 4186.009
	};

	// Initialize the tuner
	function init_tuner() {
		audioContext = new (window.AudioContext || window.webkitAudioContext)();
		analyser = audioContext.createAnalyser();
		noteDisplay = document.querySelector('.tuner-data.note');
		frequencyDisplay = document.querySelector('.tuner-data.frequency');
		tuningDisplay = document.querySelector('.tuner-data.tuning');
		feedbackDisplay = document.querySelector('.feedback');
		waveformCanvas = document.getElementById('waveform');

		// Initialize Simple Tuner
		const tuner = new SimpleTuner({
			'canvas': waveformCanvas,
			'input': 'microphone',
			'autoStart': true,
			'sensitivity': 100,
			'minimumFrequency': 30,
			'maximumFrequency': 2000
		});

		// Set up tuner callbacks
		tuner.on('note', function(note) {
			const detectedNote = note.name;
			const detectedFrequency = note.frequency;
			const tuningStatus = note.tuning;

			// Display detected note
			noteDisplay.textContent = detectedNote;
			frequencyDisplay.textContent = detectedFrequency + ' Hz';
			tuningDisplay.textContent = tuningStatus;

			// Check if the note is in tune
			checkTuning(detectedNote, detectedFrequency);
		});

		tuner.on('frequency', function(frequency) {
			// Update frequency display
			frequencyDisplay.textContent = frequency + ' Hz';
		});

		// Start rendering the tuner display
		function render() {
			tuner.render();
			requestAnimationFrame(render);
		}

		render();
	}

	// Check if the note is in tune
	function checkTuning(detectedNote, detectedFrequency) {
		// Get the expected frequency for the detected note
		const expectedFrequency = pianoNoteFrequencies[detectedNote];

		// Calculate the difference between the detected frequency and expected frequency
		const diffHz = Math.abs(detectedFrequency - expectedFrequency);
		const diffCents = 1200 * Math.log2(detectedFrequency / expectedFrequency);

		// If the difference in Hz is within a small threshold, consider the note in tune
		if (Math.abs(diffCents) < 5) {
			feedbackDisplay.textContent = detectedNote + " is in tune!";
			feedbackDisplay.style.color = "green";
		} else if (diffCents > 0) {
			feedbackDisplay.textContent = detectedNote + " is sharp. Needs tuning.";
			feedbackDisplay.style.color = "red";
		} else {
			feedbackDisplay.textContent = detectedNote + " is flat. Needs tuning.";
			feedbackDisplay.style.color = "red";
		}
	}

	</script>
</head>
<body>

	<div class="tuner tuner-ui-debug">
		<h2>Tuner Settings</h2>
		<table>
			<tbody>
				<tr>
					<td><strong>Base Frequency</strong></td>
					<td class="tuner-data base-frequency">--</td>
				</tr>
				<tr>
					<td><strong>Instrument</strong></td>
					<td class="tuner-data instrument">--</td>
				</tr>
				<tr>
					<td><strong>Tuning</strong></td>
					<td class="tuner-data tuning">--</td>
				</tr>
			</tbody>
		</table>

		<h2>Frequency Information</h2>
		<table>
			<tbody>
				<tr>
					<td><strong>Frequency (Hz)</strong></td>
					<td class="tuner-data frequency">--</td>
				</tr>
				<tr>
					<td><strong>Note</strong></td>
					<td class="tuner-data note">--</td>
				</tr>
				<tr>
					<td><strong>Tuning</strong></td>
					<td class="tuner-data tuning">--</td>
				</tr>
			</tbody>
		</table>

		<h2>Signal Information</h2>
		<table>
			<tbody>
				<tr>
					<td><strong>Waveform</strong></td>
					<td><canvas id="waveform" width="480" height="160"></canvas></td>
				</tr>
			</tbody>
		</table>

		<h2>Feedback</h2>
		<div class="feedback" style="font-size: 1.5em; color: blue;">Waiting for note...</div>
	</div>

</body>
</html>
