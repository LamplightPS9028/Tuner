<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Tuner</title>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script>

	// Wait for the page to load before initializing the tuner
	window.addEventListener('load', init_tuner, false);

	// Global variables
	let audioContext, analyser, microphone;
	let noteDisplay, frequencyDisplay, tuningDisplay, waveformCanvas, barGraphCanvas;

	// Function to initialize the tuner
	function init_tuner() {
		// Set up the Web Audio API context and the analyser
		audioContext = new (window.AudioContext || window.webkitAudioContext)();
		analyser = audioContext.createAnalyser();
		noteDisplay = document.querySelector('.tuner-data.note');
		frequencyDisplay = document.querySelector('.tuner-data.frequency');
		tuningDisplay = document.querySelector('.tuner-data.tuning');
		waveformCanvas = document.getElementById('waveform');
		barGraphCanvas = document.getElementById('bargraph');

		// Get access to the microphone
		navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
			microphone = audioContext.createMediaStreamSource(stream);
			microphone.connect(analyser);
			analyser.fftSize = 2048;
			loop();
		}).catch(function(err) {
			console.log('Error accessing microphone: ' + err);
		});
	}

	// Function to loop and process the audio data
	function loop() {
		const bufferLength = analyser.frequencyBinCount;
		const dataArray = new Uint8Array(bufferLength);
		const canvasCtx = waveformCanvas.getContext('2d');
		const barCanvasCtx = barGraphCanvas.getContext('2d');

		analyser.getByteFrequencyData(dataArray);

		// Draw waveform
		canvasCtx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
		canvasCtx.beginPath();
		const sliceWidth = waveformCanvas.width * 1.0 / bufferLength;
		let x = 0;
		for (let i = 0; i < bufferLength; i++) {
			const v = dataArray[i] / 128.0; // Scale to 0-1
			const y = v * waveformCanvas.height / 2;
			if (i === 0) {
				canvasCtx.moveTo(x, y);
			} else {
				canvasCtx.lineTo(x, y);
			}
			x += sliceWidth;
		}
		canvasCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
		canvasCtx.stroke();

		// Draw bar graph
		barCanvasCtx.clearRect(0, 0, barGraphCanvas.width, barGraphCanvas.height);
		const barWidth = barGraphCanvas.width / bufferLength;
		for (let i = 0; i < bufferLength; i++) {
			const barHeight = dataArray[i];
			barCanvasCtx.fillStyle = 'rgb(' + (barHeight + 100) + ',50,50)';
			barCanvasCtx.fillRect(i * barWidth, barGraphCanvas.height - barHeight, barWidth, barHeight);
		}

		// Pitch detection
		detectPitch(dataArray);

		// Request next animation frame
		requestAnimationFrame(loop);
	}

	// Function to detect the pitch from frequency data
	function detectPitch(dataArray) {
		const bufferLength = dataArray.length;
		let maxIndex = -1;
		let maxValue = -1;
		for (let i = 0; i < bufferLength; i++) {
			if (dataArray[i] > maxValue) {
				maxValue = dataArray[i];
				maxIndex = i;
			}
		}

		// Calculate frequency of the detected pitch
		const nyquist = audioContext.sampleRate / 2;
		const frequency = maxIndex * nyquist / (bufferLength / 2);

		// Display frequency and note information
		frequencyDisplay.textContent = frequency.toFixed(2) + ' Hz';

		const noteInfo = getPianoNoteFromFrequency(frequency);
		noteDisplay.textContent = noteInfo.note;
		tuningDisplay.textContent = noteInfo.tuning;

	}

	// Convert frequency to piano note
	function getPianoNoteFromFrequency(frequency) {
		const A440 = 440; // Frequency of A4 in Hz
		const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
		const noteIndex = Math.round(12 * Math.log(frequency / A440) / Math.log(2));
		const octave = Math.floor(noteIndex / 12) + 4; // Assume A4 is in octave 4
		const note = noteNames[(noteIndex + 120) % 12]; // Get the note name
		const tuning = (frequency - A440) > 0 ? 'Sharp' : 'Flat';

		return { note: note + octave, tuning: tuning };
	}
	</script>

</head>
<body>

	<div class="tuner tuner-ui-debug">
		<h2>Tuner Settings</h2>
		<table>
			<tbody>
				<tr>
					<td><strong>Base Frequency</strong></td>
					<td class="tuner-data base-frequency">--</td>
				</tr>
				<tr>
					<td><strong>Instrument</strong></td>
					<td class="tuner-data instrument">--</td>
				</tr>
				<tr>
					<td><strong>Tuning</strong></td>
					<td class="tuner-data tuning">--</td>
				</tr>
				<tr>
					<td><strong>Tuning information</strong></td>
					<td class="tuner-data tuning-info">--</td>
				</tr>
			</tbody>
		</table>

		<h2>Frequency Information</h2>
		<table>
			<tbody>
				<tr>
					<td><strong>Frequency (Hz)</strong></td>
					<td class="tuner-data frequency">--</td>
				</tr>
				<tr>
					<td><strong>Note</strong></td>
					<td class="tuner-data note">--</td>
				</tr>
				<tr>
					<td><strong>Tuning</strong></td>
					<td class="tuner-data tuning">--</td>
				</tr>
			</tbody>
		</table>

		<h2>Signal Information</h2>
		<table>
			<tbody>
				<tr>
					<td><strong>Waveform</strong></td>
					<td><canvas id="waveform" width="480" height="160"></canvas></td>
				</tr>
				<tr>
					<td><strong>Bar-Graph</strong></td>
					<td><canvas id="bargraph" width="480" height="160"></canvas></td>
				</tr>
			</tbody>
		</table>

	</div>

</body>
</html>
